Settings = ac.storage({
	KeyValue = 999, --key value for ac
	KeyName = "", --key name for user
	TPtoCam = false,
	ShowKeyTP = true,
	tpDistance = 8,
	SpectatePlayer = false,
	MousetoTrackRays = false,
	MousetoTrackRays_updates = "500",
	MousetoTrackRays_Chord_keyValue = 999,
	MousetoTrackRays_Chord_KeyName = "",
	MousetoTrackRays_pos_keyValue = 999,
	MousetoTrackRays_pos_KeyName = "",
	MousetoTrackRays_dir_keyValue = 999,
	MousetoTrackRays_dir_KeyName = "",
	MousetoTrackRays_TP_keyValue = 999,
	MousetoTrackRays_TP_KeyName = "",
	-- Teleport ƒ∞zin Sistemi
	AllowOthersToMe = true, -- Ba≈ükalarƒ±nƒ±n bana ƒ±≈üƒ±nlanmasƒ±na izin ver
	ShowTeleportMessage = false, -- Chat'e "ƒ±≈üƒ±nlandƒ±n" mesajƒ± g√∂ster
	-- Arkada≈ülar ve Karaliste (virg√ºlle ayrƒ±lmƒ±≈ü string olarak saklanƒ±r)
	Arkada≈ülarStr = "", -- ƒ∞znim kapalƒ± olsa bile ƒ±≈üƒ±nlanabilenler "Player1,Player2,Player3"
	KaralisteStr = "", -- ƒ∞znim a√ßƒ±k olsa bile ƒ±≈üƒ±nlanamAyanlar "Troll1,Troll2"
})

-- String'den tablo'ya √ßevirme fonksiyonlarƒ±
local function parseList(str)
	local list = {}
	if str and str ~= "" then
		for name in string.gmatch(str, "[^,]+") do
			table.insert(list, name)
		end
	end
	return list
end

local function listToString(list)
	return table.concat(list, ",")
end

-- Runtime tablolar
local Arkada≈ülar = parseList(Settings.Arkada≈ülarStr)
local Karaliste = parseList(Settings.KaralisteStr)

-- Listeyi kaydet
local function saveArkada≈ülar()
	Settings.Arkada≈ülarStr = listToString(Arkada≈ülar)
end

local function saveKaraliste()
	Settings.KaralisteStr = listToString(Karaliste)
end

-- Network ƒ∞zin Sistemi (Chat-Based)
local playerPermissions = {} -- [driverName] = true/false
local lastPermissionUpdate = {} -- [driverName] = timestamp
local myLastBroadcast = 0
local myLastBroadcastedStatus = nil -- Son broadcast edilen durum
local BROADCAST_INTERVAL = 30 -- Saniye (log spam'ini azaltmak i√ßin artƒ±rƒ±ldƒ±)
local PERMISSION_TIMEOUT = 45 -- Saniye

-- SteamID Network Payla≈üƒ±mƒ±
local playerSteamIDs = {} -- [driverName] = steamID
local mySteamID = nil
local lastSteamBroadcast = 0
local STEAM_BROADCAST_INTERVAL = 60 -- 60 saniyede bir

-- Ses olmadan chat mesajƒ± g√∂nder (gizli protokol)
local function sendHiddenMessage(msg)
	-- Chat'e g√∂nder (daha az sƒ±klƒ±kta)
	ac.sendChatMessage(msg)
end

-- Kendi izin durumunu broadcast et (sadece deƒüi≈üiklik varsa)
local function broadcastMyPermission(force)
	local status = Settings.AllowOthersToMe and "1" or "0"
	local currentTime = os.clock()
	
	-- Sadece durum deƒüi≈ümi≈üse g√∂nder (spam √∂nlemek i√ßin)
	if force or myLastBroadcastedStatus ~= status then
		local myName = ac.getDriverName(0)
		local message = "TP:" .. myName .. ":" .. status
		
		-- Arkada≈ülar varsa ekle
		if #Arkada≈ülar > 0 then
			message = message .. ":WL:" .. table.concat(Arkada≈ülar, ",")
		end
		
		-- Karaliste varsa ekle
		if #Karaliste > 0 then
			message = message .. ":BL:" .. table.concat(Karaliste, ",")
		end
		
		sendHiddenMessage(message)
		myLastBroadcast = currentTime
		myLastBroadcastedStatus = status
    end
end

-- SteamID broadcast et
local function broadcastMySteamID(force)
	local currentTime = os.clock()
	
	-- ƒ∞lk kez al
	if not mySteamID and ac.getUserSteamID then
		mySteamID = ac.getUserSteamID()
	end
	
	-- Eƒüer SteamID varsa ve broadcast zamanƒ± geldiyse
	if mySteamID and mySteamID ~= "" and mySteamID ~= "0" then
		if force or (currentTime - lastSteamBroadcast) >= STEAM_BROADCAST_INTERVAL then
			local myName = ac.getDriverName(0)
			sendHiddenMessage("STEAM:" .. myName .. ":" .. mySteamID)
			lastSteamBroadcast = currentTime
		end
	end
end

-- Arkada≈ülar/Karaliste kontrol fonksiyonlarƒ±
local function isInArkada≈ülar(playerName)
	for _, name in ipairs(Arkada≈ülar) do
		if name == playerName then
			return true
		end
	end
	return false
end

local function isInKaraliste(playerName)
	for _, name in ipairs(Karaliste) do
		if name == playerName then
			return true
		end
	end
	return false
end

local function addToArkada≈ülar(playerName)
	-- Karaliste'ten √ßƒ±kar
	for i, name in ipairs(Karaliste) do
		if name == playerName then
			table.remove(Karaliste, i)
			break
		end
	end
	saveKaraliste()
	
	-- Arkada≈ülar'a ekle (eƒüer yoksa)
	if not isInArkada≈ülar(playerName) then
		table.insert(Arkada≈ülar, playerName)
		saveArkada≈ülar()
		-- Hemen broadcast et
		broadcastMyPermission(true)
	end
end

local function addToKaraliste(playerName)
	-- Arkada≈ülar'dan √ßƒ±kar
	for i, name in ipairs(Arkada≈ülar) do
		if name == playerName then
			table.remove(Arkada≈ülar, i)
			break
		end
	end
	saveArkada≈ülar()
	
	-- Karaliste'ye ekle (eƒüer yoksa)
	if not isInKaraliste(playerName) then
		table.insert(Karaliste, playerName)
		saveKaraliste()
		-- Hemen broadcast et
		broadcastMyPermission(true)
	end
end

local function removeFromArkada≈ülar(playerName)
	for i, name in ipairs(Arkada≈ülar) do
		if name == playerName then
			table.remove(Arkada≈ülar, i)
			saveArkada≈ülar()
			-- Hemen broadcast et
			broadcastMyPermission(true)
			return true
		end
	end
	return false
end

local function removeFromKaraliste(playerName)
	for i, name in ipairs(Karaliste) do
		if name == playerName then
			table.remove(Karaliste, i)
			saveKaraliste()
			-- Hemen broadcast et
			broadcastMyPermission(true)
			return true
		end
	end
	return false
end

-- Oyuncunun bana ƒ±≈üƒ±nlanƒ±p ƒ±≈üƒ±nlanamayacaƒüƒ±nƒ± kontrol et
local function canPlayerTeleportToMe(playerName)
	-- Karaliste kontrol√º (√∂ncelikli)
	if isInKaraliste(playerName) then
		return false -- Karaliste'de ise ASLA ƒ±≈üƒ±nlanamaz
	end
	
	-- Arkada≈ülar kontrol√º
	if isInArkada≈ülar(playerName) then
		return true -- Arkada≈ülar'da ise HER ZAMAN ƒ±≈üƒ±nlanabilir
	end
	
	-- Normal izin kontrol√º
	return Settings.AllowOthersToMe
end

-- Remote oyuncu izinlerini sakla (arkada≈ülar/karaliste dahil)
local remotePlayerLists = {} -- [playerName] = {arkada≈ülar={}, karaliste={}, allow=true/false}

-- Chat mesajlarƒ±nƒ± i≈üle (izin mesajlarƒ±nƒ± parse et)
local function processChatMessage(message, senderCarIndex)
	-- Format: STEAM:playerName:steamID
	if string.sub(message, 1, 6) == "STEAM:" then
		local parts = {}
		for part in string.gmatch(message, "[^:]+") do
			table.insert(parts, part)
		end
		
		if #parts == 3 and parts[1] == "STEAM" then
			local playerName = parts[2]
			local steamID = parts[3]
			
			if playerName and steamID then
				playerSteamIDs[playerName] = steamID
			end
		end
		return true -- Mesajƒ± gizle
	end
	
	-- Format: TP:playerName:status[:WL:name1,name2][:BL:name3,name4]
	if string.sub(message, 1, 3) == "TP:" then
		-- Mesajƒ± parse et
		local parts = {}
		for part in string.gmatch(message, "[^:]+") do
			table.insert(parts, part)
		end
		
		if #parts >= 3 and parts[1] == "TP" then
			local playerName = parts[2]
			local status = parts[3]
			
			-- Remote oyuncu bilgilerini sakla
			if not remotePlayerLists[playerName] then
				remotePlayerLists[playerName] = {arkada≈ülar = {}, karaliste = {}, allow = true}
			end
			
			-- Genel izin durumu
			remotePlayerLists[playerName].allow = (status == "1")
			remotePlayerLists[playerName].arkada≈ülar = {}
			remotePlayerLists[playerName].karaliste = {}
			
			-- Arkada≈ülar (WL) ve Karaliste (BL) parse et
			local i = 4
			while i <= #parts do
				if parts[i] == "WL" and parts[i+1] then
					-- Arkada≈ülar (WL)
					for name in string.gmatch(parts[i+1], "[^,]+") do
						table.insert(remotePlayerLists[playerName].arkada≈ülar, name)
					end
					i = i + 2
				elseif parts[i] == "BL" and parts[i+1] then
					-- Karaliste (BL)
					for name in string.gmatch(parts[i+1], "[^,]+") do
						table.insert(remotePlayerLists[playerName].karaliste, name)
					end
					i = i + 2
				else
					i = i + 1
				end
			end
			
			-- Genel izin durumunu g√ºncelle (eski sistem uyumluluƒüu i√ßin)
			-- Ben ona ƒ±≈üƒ±nlanabilir miyim kontrol√º
			local myName = ac.getDriverName(0)
			local canITeleport = false
			
			-- Karaliste'de miyim?
			local inKaraliste = false
			for _, name in ipairs(remotePlayerLists[playerName].karaliste) do
				if name == myName then
					inKaraliste = true
					break
				end
			end
			
			if inKaraliste then
				canITeleport = false
			else
				-- Arkada≈ülar'da mƒ±yƒ±m?
				local inArkada≈ülar = false
				for _, name in ipairs(remotePlayerLists[playerName].arkada≈ülar) do
					if name == myName then
						inArkada≈ülar = true
						break
					end
				end
				
				if inArkada≈ülar then
					canITeleport = true
				else
					canITeleport = remotePlayerLists[playerName].allow
				end
			end
			
			playerPermissions[playerName] = canITeleport
			lastPermissionUpdate[playerName] = os.clock()
			
			return true -- Mesajƒ± gizle (eƒüer API destekliyorsa)
		end
	end
	return false -- Normal mesajlarƒ± g√∂ster
end

-- Chat filtreleme - birden fazla y√∂ntem dene
local chatFilterInstalled = false

-- Y√∂ntem 1: ac.onChatMessage (CSP 0.1.77+)
pcall(function()
	if ac.onChatMessage then
		ac.onChatMessage(function(message, senderCarIndex)
			local shouldHide = processChatMessage(message, senderCarIndex)
			return shouldHide -- true = mesajƒ± gizle
		end)
		chatFilterInstalled = true
	end
end)

-- Y√∂ntem 2: ac.setChatMessageFilter (eski CSP)
pcall(function()
	if not chatFilterInstalled and ac.setChatMessageFilter then
		ac.setChatMessageFilter(function(message)
			local shouldHide = processChatMessage(message, 0)
			return not shouldHide -- false = mesajƒ± gizle
		end)
		chatFilterInstalled = true
	end
end)

-- Y√∂ntem 3: ac.addChatMessageListener
pcall(function()
	if not chatFilterInstalled and ac.addChatMessageListener then
		ac.addChatMessageListener(function(message, sender)
			processChatMessage(message, sender)
		end)
		chatFilterInstalled = true
	end
end)

-- ƒ∞lk ba≈ülangƒ±√ßta kendi izni ve SteamID'yi broadcast et (sadece bir kere)
setTimeout(function()
	broadcastMyPermission(true)
	broadcastMySteamID(true)
end, 3)

local timer = {
	running = 0,	--we move length/blength into here
	length = 0,		--the normal length after teleporting
	blength = 0,	--length after setting a button
}

local OverlayTimerKey = false -- Overlay g√∂sterimi i√ßin
local selectedCarIndex = nil -- Se√ßili oyuncu index'i

--#region [Menu]
local function Teleportation()
	--showing timer seems logical to me here
	ui.text("Bekleme S√ºresi: " .. math.round(timer.running, 1))

	ui.tabBar("Atabbar", function()
		ui.tabItem("I≈üƒ±nlanma Men√ºs√º", CartoCar_UI)
		ui.tabItem("ƒ∞zin Ayarlarƒ±", PermissionSettings_UI)
		ui.tabItem("Arkada≈ülar/Karaliste", Arkada≈ülarKaraliste_UI)
		ui.tabItem("Oyuncular Bilgisi", WHOIS_UI)
	end)
end

-- ƒ∞zin Ayarlarƒ± Men√ºs√º
function PermissionSettings_UI()
	ui.header("Teleport ƒ∞zin Sistemi")
	ui.separator()
	
	-- Ba≈ükalarƒ±nƒ±n bana ƒ±≈üƒ±nlanmasƒ± (NETWORK KORUMASLI)
	ui.text("Ba≈ükalarƒ±nƒ±n Sana I≈üƒ±nlanmasƒ±:")
	local oldSetting = Settings.AllowOthersToMe
	if ui.checkbox("Ba≈ükalarƒ±nƒ±n bana ƒ±≈üƒ±nlanmasƒ±na izin ver##allowothers", Settings.AllowOthersToMe) then
		Settings.AllowOthersToMe = not Settings.AllowOthersToMe
		-- Deƒüi≈üikliƒüi hemen broadcast et (force = true)
		broadcastMyPermission(true)
	end
	
	if not Settings.AllowOthersToMe then
		ui.textColored("üö´ Ba≈ükalarƒ± SANA ƒ±≈üƒ±nlanamaz.", rgbm(1, 0.3, 0.3, 1))
		if #Arkada≈ülar > 0 then
			ui.textWrapped("‚ö† Ancak Arkada≈ülar listesindeki " .. #Arkada≈ülar .. " oyuncu ƒ±≈üƒ±nlanabilir.")
		else
			ui.textWrapped("Diƒüer oyuncular seni listede 'üö´ Kapalƒ±' olarak g√∂recek.")
		end
	else
		ui.textColored("‚úÖ Ba≈ükalarƒ± sana ƒ±≈üƒ±nlanabilir.", rgbm(0.3, 1, 0.3, 1))
		if #Karaliste > 0 then
			ui.textWrapped("‚ö† Ancak Karaliste'deki " .. #Karaliste .. " oyuncu ƒ±≈üƒ±nlanamaz.")
		else
			ui.textWrapped("Diƒüer oyuncular seni listede '‚úÖ A√ßƒ±k' olarak g√∂recek.")
		end
	end
	
	ui.separator()
	
	-- Teleport Bildirimi Ayarƒ±
	ui.text("Diƒüer Ayarlar:")
	if ui.checkbox("Chat'e 'I≈üƒ±nlandƒ±n' mesajƒ± g√∂ster##showtpmsg", Settings.ShowTeleportMessage) then
		Settings.ShowTeleportMessage = not Settings.ShowTeleportMessage
	end
	ui.textWrapped("I≈üƒ±nlandƒ±ƒüƒ±nƒ±zda chat'e bildirim mesajƒ± g√∂nderir.")
	
	ui.separator()
	
	-- ƒ∞statistikler
	ui.separator()
	ui.text("üìä Network ƒ∞statistikleri:")
	
	local activePermissions = 0
	for name, perm in pairs(playerPermissions) do
		if perm ~= nil then activePermissions = activePermissions + 1 end
	end
	ui.textWrapped("üåê Alƒ±nan izin bilgileri: " .. activePermissions .. " oyuncu")
	
	if not chatFilterInstalled then
		ui.newLine()
		ui.textColored("‚ö† Chat Filtresi Y√ºklenemedi", rgbm(1, 1, 0, 1))
		ui.textWrapped("Chat'te 'TP:' ile ba≈ülayan mesajlar g√∂r√ºlebilir. Bunlar izin protokol√ºd√ºr, g√∂rmezden gelebilirsiniz.")
	else
		ui.textColored("‚úÖ Chat Filtresi: Aktif", rgbm(0.3, 1, 0.3, 1))
	end
	
	ui.newLine()
	ui.textWrapped("üí° Bu script'i kullanmayan oyuncular '‚ùì Bilinmiyor' olarak g√∂r√ºn√ºr.")
end

-- Arkada≈ülar/Karaliste Y√∂netim Men√ºs√º
function Arkada≈ülarKaraliste_UI()
	ui.header("Arkada≈ülar ve Karaliste Y√∂netimi")
	ui.separator()
	
	ui.textWrapped("üîí Arkada≈ülar: ƒ∞zniniz kapalƒ± olsa bile bu oyuncular size ƒ±≈üƒ±nlanabilir.")
	ui.textWrapped("‚õî Karaliste: ƒ∞zniniz a√ßƒ±k olsa bile bu oyuncular size ƒ±≈üƒ±nlanamaz.")
	ui.separator()
	
	-- Aktif oyuncularƒ± listele
	ui.text("Sunucudaki Oyuncular:")
	ui.childWindow("##playerslist", vec2(ui.availableSpaceX(), 300), function()
		for i = 1, sim.carsCount - 1 do
			local car = ac.getCar(i)
			local driverName = ac.getDriverName(i)
			
			if car.isConnected and not car.isAIControlled and not string.find(driverName, "NGG Trafik") then
				local isArkada≈ü = isInArkada≈ülar(driverName)
				local isKaraliste = isInKaraliste(driverName)
				
				-- Oyuncu durumu ikonu
				local statusIcon = ""
				local statusColor = rgbm(1, 1, 1, 1)
				
				if isArkada≈ü then
					statusIcon = "‚úÖ "
					statusColor = rgbm(0.3, 1, 0.3, 1)
				elseif isKaraliste then
					statusIcon = "‚õî "
					statusColor = rgbm(1, 0.3, 0.3, 1)
				else
					statusIcon = "‚ö™ "
					statusColor = rgbm(0.8, 0.8, 0.8, 1)
				end
				
				ui.pushStyleColor(ui.StyleColor.Text, statusColor)
				ui.text(statusIcon .. driverName)
				ui.popStyleColor()
				
				-- Butonlar
				ui.sameLine()
				
				if isArkada≈ü then
					if ui.button("Arkada≈ülar'dan √áƒ±kar##wl" .. i) then
						removeFromArkada≈ülar(driverName)
					end
				else
					if ui.button("Arkada≈ülar'a Ekle##wl" .. i) then
						addToArkada≈ülar(driverName)
        end
    end
				
				ui.sameLine()
				
				if isKaraliste then
					if ui.button("Karaliste'den √áƒ±kar##bl" .. i) then
						removeFromKaraliste(driverName)
					end
				else
					if ui.button("Karaliste'ye Ekle##bl" .. i) then
						addToKaraliste(driverName)
            end
        end
    end
end
	end)
	
	ui.separator()
	
	-- ƒ∞statistikler
	ui.text("üìä ƒ∞statistikler:")
	ui.textWrapped("‚úÖ Arkada≈ülar'da " .. #Arkada≈ülar .. " oyuncu")
	ui.textWrapped("‚õî Karaliste'de " .. #Karaliste .. " oyuncu")
	
	ui.separator()
	
	-- Temizleme butonlarƒ±
	if #Arkada≈ülar > 0 then
		if ui.button("T√ºm Arkada≈ülar'ƒ± Temizle") then
			Arkada≈ülar = {}
			saveArkada≈ülar()
			broadcastMyPermission(true)
		end
	end
	
	if #Karaliste > 0 then
		ui.sameLine()
		if ui.button("T√ºm Karaliste'yi Temizle") then
			Karaliste = {}
			saveKaraliste()
			broadcastMyPermission(true)
		end
	end
	
	ui.newLine()
	ui.textWrapped("üí° ƒ∞pucu: Karaliste en y√ºksek √∂nceliƒüe sahiptir. Arkada≈ülar listesi izin kapalƒ±yken etkilidir.")
end

-- WHOIS Bilgisi Men√ºs√º
function WHOIS_UI()
	ui.header("WHOIS - Oyuncu Bilgileri")
	ui.separator()
	
	ui.textWrapped("üîç Sunucudaki t√ºm oyuncularƒ±n detaylƒ± bilgilerini g√∂rebilirsiniz.")
	ui.separator()
	
	-- Oyuncu sayƒ±sƒ±
	local onlineCount = 0
	for i = 0, sim.carsCount - 1 do
		local car = ac.getCar(i)
		if car and car.isConnected and not car.isAIControlled then
			local driverName = ac.getDriverName(i)
			if driverName then
				local isTraffic = string.find(driverName, "NGG Trafik") ~= nil
				if not isTraffic then
					onlineCount = onlineCount + 1
				end
			end
		end
	end
	
	ui.text("üåê Toplam Oyuncu: " .. onlineCount)
	ui.separator()
	
	-- Oyuncu listesi  
	ui.childWindow("##whoislist", vec2(ui.availableSpaceX(), 450), function()
		for i = 0, sim.carsCount - 1 do
			local car = ac.getCar(i)
			if car and car.isConnected and not car.isAIControlled then
				local driverName = ac.getDriverName(i)
				local isTraffic = driverName and string.find(driverName, "NGG Trafik") ~= nil
				if driverName and driverName ~= "" and not isTraffic then
					-- Oyuncu bilgi kartƒ±
					ui.pushFont(ui.Font.Title)
					if i == 0 then
						ui.textColored("üë§ " .. driverName .. " (Sen)", rgbm(0.3, 1, 0.3, 1))
					else
						ui.text("üë§ " .. driverName)
					end
    ui.popFont()
	
					
					-- SteamID64 / GUID (g√ºvenli √ßaƒürƒ±)
					local steamID = nil
					local idType = "Bilinmiyor"
					
					-- Y√∂ntem 1: ac.getUserSteamID() - lokal oyuncu i√ßin
					if i == 0 and ac.getUserSteamID then
						steamID = ac.getUserSteamID()
						idType = "SteamID64"
					end
					
					-- Y√∂ntem 2: Network'ten payla≈üƒ±lan SteamID (√∂ncelikli)
					if (not steamID or steamID == "" or steamID == "0") and playerSteamIDs[driverName] then
						steamID = playerSteamIDs[driverName]
						idType = "SteamID64"
					end
					
					-- Y√∂ntem 3: Multiplayer session bilgisi (CSP)
					if (not steamID or steamID == "" or steamID == "0") and ac.getSession then
						local session = ac.getSession(i)
						if session and session.steamID then
							steamID = session.steamID
							idType = "SteamID64"
						end
					end
					
					-- Y√∂ntem 4: ac.getDriverGUID() - t√ºm oyuncular i√ßin
					if not steamID or steamID == "" or steamID == "0" then
						if ac.getDriverGUID then
							steamID = ac.getDriverGUID(i)
							if steamID and steamID ~= "" and steamID ~= "0" then
								idType = "GUID"
							end
						end
					end
					
					if steamID and steamID ~= "" and steamID ~= "0" then
						ui.text("  üîë " .. idType .. ": " .. steamID)
						
						-- Kopyalama butonu
						ui.sameLine()
						if ui.button("Kopyala##steam" .. i) then
							ui.setClipboardText(steamID)
						end
						
						-- Steam profil linki (sadece SteamID64 i√ßin)
						if idType == "SteamID64" then
							ui.sameLine()
							if ui.button("Steam Profil##profile" .. i) then
								os.openURL("https://steamcommunity.com/profiles/" .. steamID)
							end
						end
					else
						ui.textColored("  üîë ID: Mevcut deƒüil (API desteƒüi yok)", rgbm(1, 0.7, 0, 1))
					end
					
					-- Ara√ß bilgisi
					local carName = ac.getCarName(i) or "Bilinmiyor"
					ui.text("  üöó Ara√ß: " .. carName)
					
					-- Baƒülantƒ± bilgisi
					ui.textColored("  üü¢ Durum: Online", rgbm(0.3, 1, 0.3, 1))
					
					-- √úlke kodu
					local nationCode = ac.getDriverNationCode(i)
					if nationCode and nationCode ~= "" then
						ui.text("  üåç √úlke: " .. nationCode)
					end
					
					-- ƒ∞zin durumu
					local permission = playerPermissions[driverName]
					if i ~= 0 then
						if permission == true then
							ui.textColored("  ‚úÖ Teleport ƒ∞zni: A√ßƒ±k", rgbm(0.3, 1, 0.3, 1))
						elseif permission == false then
							ui.textColored("  üö´ Teleport ƒ∞zni: Kapalƒ±", rgbm(1, 0.3, 0.3, 1))
						else
							ui.textColored("  ‚ùì Teleport ƒ∞zni: Bilinmiyor", rgbm(0.7, 0.7, 0.7, 1))
						end
					end
					
					-- Arkada≈ülar/Karaliste durumu
					if i ~= 0 then
						local isArkada≈ü = isInArkada≈ülar(driverName)
						local isKaraliste = isInKaraliste(driverName)
						
						if isArkada≈ü then
							ui.textColored("  üíö Listede: Arkada≈ülar", rgbm(0.3, 1, 0.3, 1))
						elseif isKaraliste then
							ui.textColored("  ‚õî Listede: Karaliste", rgbm(1, 0.3, 0.3, 1))
						else
							ui.text("  ‚ö™ Listede: Normal")
						end
					end
					
					-- Hƒ±z ve mesafe bilgisi (kendin dƒ±≈üƒ±ndaki oyuncular i√ßin)
					if i ~= 0 then
						local speed = math.sqrt(car.velocity.x^2 + car.velocity.z^2) * 3.6
						ui.text(string.format("  üí® Hƒ±z: %.0f km/h", speed))
						
						local myCar = ac.getCar(0)
						if myCar then
							local distance = math.sqrt(
								(car.position.x - myCar.position.x)^2 + 
								(car.position.y - myCar.position.y)^2 + 
								(car.position.z - myCar.position.z)^2
							)
							ui.text(string.format("  üìç Mesafe: %.0f m", distance))
						end
					end
					
					ui.separator()
				end
			end
		end
	end)
	
	ui.separator()
	ui.textWrapped("üí° ƒ∞pucu: SteamID64'√º kopyalayƒ±p Steam'de arama yapabilir veya direkt profil linkine gidebilirsiniz.")
end
--#endregion

--#region [Car to Car] --physics stuff works in ui shit too so lol
function CartoCar_UI()
	ui.text("I≈üƒ±nlanacaƒüƒ±n Arkada≈üƒ±nƒ± Se√ß ve 'I≈ûINLAN' tu≈üuna bas.")
	
	-- Se√ßili oyuncunun izin durumunu g√∂ster
	if selectedCar and selectedCarIndex then
		local targetName = ac.getDriverName(selectedCarIndex)
		local hasPermission = playerPermissions[targetName]
		
		if hasPermission == false then
			ui.textColored("üö´ Bu oyuncu teleportlarƒ± kapatmƒ±≈ü! I≈üƒ±nlanamazsƒ±n.", rgbm(1, 0.3, 0.3, 1))
		elseif hasPermission == true then
			ui.textColored("‚úÖ Bu oyuncu teleportlarƒ± kabul ediyor.", rgbm(0.3, 1, 0.3, 1))
		else
			ui.textColored("‚ùì Bu oyuncunun izin durumu bilinmiyor (script yok olabilir).", rgbm(0.7, 0.7, 0.7, 1))
		end
	end
	
	-- Cooldown kontrol√º
	if timer.running > 0 then
		ui.textColored("‚è± Bekleme s√ºresi: " .. math.round(timer.running, 1) .. " saniye", rgbm(1, 1, 0.3, 1))
	end
	
	-- I≈üƒ±nlan butonu - izin kontrol√º eklendi
	local canTeleport = selectedCar and timer.running <= 0
	local targetName = selectedCarIndex and ac.getDriverName(selectedCarIndex)
	local targetPermission = targetName and playerPermissions[targetName]
	
	-- Eƒüer hedef oyuncu DENY etmi≈üse, buton devre dƒ±≈üƒ±
	if targetPermission == false then
		ui.pushStyleColor(ui.StyleColor.Button, rgbm(0.3, 0.3, 0.3, 1))
		ui.pushStyleColor(ui.StyleColor.ButtonHovered, rgbm(0.4, 0.4, 0.4, 1))
		ui.pushStyleColor(ui.StyleColor.ButtonActive, rgbm(0.3, 0.3, 0.3, 1))
		ui.button("I≈üƒ±nlan (ƒ∞zin Yok! üö´)")
		ui.popStyleColor(3)
	elseif ui.button("I≈üƒ±nlan") and canTeleport then
		timer.running = timer.length
		local dir = selectedCar.look

		local playerVelocity = ac.getCarState(1).velocity
		local playerGear = ac.getCarState(1).gear
		local playerRPM = ac.getCarState(1).rpm

		physics.setCarPosition(0, selectedCar.position + vec3(0, 0.1, 0) - dir * 10, -dir)
		physics.setCarVelocity(0, playerVelocity)

		physics.engageGear(0, playerGear)
		physics.setEngineRPM(0, playerRPM)
		
		-- Bildirim (ayarlarda a√ßƒ±ksa g√∂ster)
		if Settings.ShowTeleportMessage then
			if selectedCarIndex then
				ac.sendChatMessage("‚úà " .. targetName .. " oyuncusuna ƒ±≈üƒ±nlandƒ±n!")
			else
				ac.sendChatMessage("‚úà I≈üƒ±nlandƒ±n!")
			end
		end
	end
	
	ui.separator()
	ui.text("I≈üƒ±nlanacaƒüƒ±n Arkada≈üƒ±nƒ± Se√ß:")
	ui.childWindow("##drivers", vec2(ui.availableSpaceX(), 480), function()
		for i = 1, sim.carsCount - 1 do
			local car = ac.getCar(i)
			local driverName = ac.getDriverName(i)
			
			if car.isConnected and not car.isAIControlled and not string.find(driverName, "NGG Trafik") then
				-- ƒ∞zin durumuna g√∂re ikon ekle
				local permissionIcon = ""
				local permissionColor = rgbm(1, 1, 1, 1)
				local extraInfo = ""
				
				local permission = playerPermissions[driverName]
				
				-- Remote player'ƒ±n arkada≈ülar/karaliste durumunu kontrol et
				local myName = ac.getDriverName(0)
				if remotePlayerLists[driverName] then
					local lists = remotePlayerLists[driverName]
					-- Ben onun karaliste'sinde miyim?
					for _, name in ipairs(lists.karaliste) do
						if name == myName then
							extraInfo = " [‚õîKaraliste]"
							break
						end
					end
					-- Ben onun arkada≈ülarƒ±'nda mƒ±yƒ±m?
					if extraInfo == "" then
						for _, name in ipairs(lists.arkada≈ülar) do
							if name == myName then
								extraInfo = " [‚úÖArkada≈ü]"
								break
							end
						end
					end
				end
				
				if permission == true then
					permissionIcon = "‚úÖ "
					permissionColor = rgbm(0.3, 1, 0.3, 1)
				elseif permission == false then
					permissionIcon = "üö´ "
					permissionColor = rgbm(1, 0.3, 0.3, 1)
				else
					permissionIcon = "‚ùì "
					permissionColor = rgbm(0.7, 0.7, 0.7, 1)
				end
				
				ui.pushStyleColor(ui.StyleColor.Text, permissionColor)
				if ui.selectable(permissionIcon .. driverName .. extraInfo, selectedCar == car) then
					selectedCar = car
					selectedCarIndex = i
					if Settings.SpectatePlayer == true then
						ac.focusCar(i)
					end
				end
				ui.popStyleColor()
			end
		end
	end)
	
	ui.separator()
	ui.textWrapped("üí° ƒ∞konlar:")
	ui.text("  ‚úÖ = ƒ∞zin Var | üö´ = ƒ∞zin Yok | ‚ùì = Bilinmiyor")
	ui.text("  [‚úÖArkada≈ü] = Arkada≈ülarƒ±'nda | [‚õîKaraliste] = Karaliste'sinde")
end




function script.update(dt)
	--#region [Timer]
	if timer.running >= 0 then -- timer for anything to go
		timer.running = timer.running - dt
	end
	--#endregion
	
	--#region [Network - Permission Broadcast]
	local currentTime = os.clock()
	
	-- SteamID broadcast (periyodik, sessizce)
	broadcastMySteamID(false)
	
	-- Periyodik broadcast kaldƒ±rƒ±ldƒ± (log spam'i √∂nlemek i√ßin)
	-- Sadece durum deƒüi≈ütiƒüinde broadcast yapƒ±lacak
	
	-- Eski izinleri temizle (timeout olmu≈ülar)
	for playerName, lastUpdate in pairs(lastPermissionUpdate) do
		if currentTime - lastUpdate > PERMISSION_TIMEOUT then
			playerPermissions[playerName] = nil
			lastPermissionUpdate[playerName] = nil
		end
	end
	
	-- √áƒ±kmƒ±≈ü oyuncularƒ±n izinlerini temizle
	for playerName, _ in pairs(playerPermissions) do
		local found = false
		for i = 0, sim.carsCount - 1 do
			if ac.getDriverName(i) == playerName then
				local car = ac.getCar(i)
				if car and car.isConnected then
					found = true
					break
				end
			end
		end
		if not found then
			playerPermissions[playerName] = nil
			lastPermissionUpdate[playerName] = nil
		end
	end
	--#endregion
end

function script.drawUI()
	if OverlayTimerKey == true then
		ui.transparentWindow("Keyandabindandacooldown", vec2(-15, -5), vec2(150, 150), false, function()
			ui.text("Key: " .. Settings.KeyName .. "\nBekleme S√ºresi: " .. math.round(timer.running, 1))
		end)
end
end

ui.registerOnlineExtra(ui.Icons.Compass, "Arkada≈üƒ±na I≈üƒ±nlan!", nil, Teleportation,nil, ui.OnlineExtraFlags.Tool, ui.WindowFlags.NoScrollWithMouse)
